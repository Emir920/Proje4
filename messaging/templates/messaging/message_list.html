{% extends 'messaging/base.html' %}
{% load messaging_tags %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
      <!-- Header with Icon -->
      <div class="mb-5">
        <h1 class="display-6 mb-2">
          <i class="fas fa-comments" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> 
          Message Wall
        </h1>
        <p class="text-muted">Share your thoughts and connect with others</p>
      </div>

      <!-- Search Form -->
      <form method="get" class="mb-5">
        <div class="input-group input-group-lg">
          <input type="text" name="q" class="form-control" placeholder="Search messages..." value="{{ request.GET.q }}" style="border-right: none;">
          <button class="btn btn-outline-primary" type="submit">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </form>

      <!-- New Message Form -->
      <div class="card mb-5">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="fas fa-pen-fancy"></i> Write a Message
          </h5>
          <form id="messageForm" method="post">
            {% csrf_token %}
            <div class="mb-3">
              <textarea id="messageInput" name="text" class="form-control" rows="4" placeholder="Share your thoughts..." style="resize: vertical;"></textarea>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                <span id="charCount">0</span> / 500 characters
              </small>
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-paper-plane"></i> Post
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Messages Count Badge -->
      <div class="mb-3">
        <span class="badge bg-primary" style="font-size: 0.95rem;">
          <i class="fas fa-envelope"></i> {{ messages.count }} messages
        </span>
      </div>

      <!-- Messages -->
      <div id="messages">
        {% for message in messages %}
        <div class="card mb-3 message" data-id="{{ message.id }}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div class="d-flex align-items-center gap-2">
                <div class="avatar rounded-circle bg-gradient p-2" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-user"></i>
                </div>
                <div>
                  <h6 class="mb-0 fw-bold">{{ message.author.username }}</h6>
                  <small class="text-muted">
                    <i class="fas fa-clock"></i> {{ message.timestamp|date:"M d, Y H:i" }}
                  </small>
                </div>
              </div>
              {% if message.author == user %}
              <a href="{% url 'delete_message' message.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">
                <i class="fas fa-trash-alt"></i>
              </a>
              {% endif %}
            </div>
            
            <p class="card-text mb-3">{{ message.text }}</p>
            
            <!-- Reactions Bar -->
            <div class="reactions border-top pt-3">
              <span onclick="react(this, 'like')" data-type="like" class="reaction-button {% if user_reactions|get:message.id == 'like' %}active{% endif %}" title="Like">
                <i class="fas fa-heart"></i> 
                <small class="ms-1">{{ message.like_count }}</small>
              </span>
              <span onclick="react(this, 'laugh')" data-type="laugh" class="reaction-button {% if user_reactions|get:message.id == 'laugh' %}active{% endif %}" title="Laugh">
                <i class="fas fa-laugh"></i> 
                <small class="ms-1">{{ message.laugh_count }}</small>
              </span>
              <span onclick="react(this, 'sad')" data-type="sad" class="reaction-button {% if user_reactions|get:message.id == 'sad' %}active{% endif %}" title="Sad">
                <i class="fas fa-sad-tear"></i> 
                <small class="ms-1">{{ message.sad_count }}</small>
              </span>
              <span onclick="react(this, 'fire')" data-type="fire" class="reaction-button {% if user_reactions|get:message.id == 'fire' %}active{% endif %}" title="Fire">
                <i class="fas fa-fire"></i> 
                <small class="ms-1">{{ message.fire_count }}</small>
              </span>
              <span onclick="react(this, 'thumbs_up')" data-type="thumbs_up" class="reaction-button {% if user_reactions|get:message.id == 'thumbs_up' %}active{% endif %}" title="Thumbs Up">
                <i class="fas fa-thumbs-up"></i> 
                <small class="ms-1">{{ message.thumbs_up_count }}</small>
              </span>
              <span onclick="react(this, 'angry')" data-type="angry" class="reaction-button {% if user_reactions|get:message.id == 'angry' %}active{% endif %}" title="Angry">
                <i class="fas fa-angry"></i> 
                <small class="ms-1">{{ message.angry_count }}</small>
              </span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
      <nav aria-label="Message pagination" class="mt-4">
        <ul class="pagination pagination-lg justify-content-center">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Previous">
              <i class="fas fa-chevron-left"></i> Previous
            </a>
          </li>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
          <li class="page-item {% if page_obj.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
          </li>
          {% endfor %}
          
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Next">
              Next <i class="fas fa-chevron-right"></i>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .reaction-button {
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
    background-color: transparent;
    color: #666;
    margin-right: 8px;
  }

  .reaction-button:hover {
    background-color: rgba(102, 126, 234, 0.1);
    color: #667eea;
    transform: translateY(-2px);
  }

  .reaction-button.active {
    background-color: rgba(102, 126, 234, 0.2);
    color: #667eea;
    font-weight: 600;
  }

  #charCount {
    font-weight: 600;
    color: #667eea;
  }
</style>

<script>
  // Character counter
  const messageInput = document.getElementById('messageInput');
  const charCount = document.getElementById('charCount');
  
  messageInput.addEventListener('input', function() {
    charCount.textContent = this.value.length;
    if (this.value.length > 500) {
      this.value = this.value.substring(0, 500);
      charCount.textContent = '500';
    }
  });

  document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('{% url "add_message" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    }).then(response => {
      if (response.ok) {
        location.reload();
      }
    });
  });

  function react(element, reactionType) {
    const messageDiv = element.closest('.message');
    const messageId = messageDiv.dataset.id;
    fetch(`/react/${messageId}/${reactionType}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json'
      }
    }).then(response => response.json()).then(data => {
      element.querySelector('small').textContent = data.count;
      element.classList.toggle('active');
    });
  }
</script>
{% endblock %}
